generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================
enum UserRole {
  ADMIN
  EMPLOYER
  CANDIDATE
}

enum JobStatus {
  DRAFT
  UNPAID
  ACTIVE
  EXPIRED
  ARCHIVED
  BANNED
}

enum ApplicationStatus {
  PENDING
  UNDER_REVIEW
  SHORTLISTED
  INTERVIEWED
  REJECTED
  HIRED
  WITHDRAWN
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
  REFUNDED
}

enum InterviewStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  FAILED
}

enum NotificationType {
  JOB_APPLICATION
  INTERVIEW_SCHEDULED
  APPLICATION_STATUS_CHANGE
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  SYSTEM_ALERT
}

// ==================== MODELS ====================
model User {
  id                String    @id @default(cuid())
  email             String    @unique
  password          String
  role              UserRole
  isActive          Boolean   @default(true)
  isVerified        Boolean   @default(false)
  verificationToken String?
  resetToken        String?
  resetTokenExpiry  DateTime?
  lastLogin         DateTime?
  
  // Profile relations
  adminProfile      AdminProfile?
  employerProfile   EmployerProfile?
  candidateProfile  CandidateProfile?
  
  // Relations
  notifications     Notification[]
  sessions          Session[]
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([email, role])
  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  deviceInfo   String?
  ipAddress    String?
  lastActivity DateTime @default(now())
  expiresAt    DateTime
  isValid      Boolean  @default(true)
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([userId])
  @@map("sessions")
}

model AdminProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  fullName    String
  phoneNumber String?
  avatar      String?
  department  String   @default("Administration")
  permissions Json     @default("[]")
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("admin_profiles")
}

model EmployerProfile {
  id               String   @id @default(cuid())
  userId           String   @unique
  companyName      String
  companyEmail     String   @unique
  phoneNumber      String
  companyLogo      String?
  companyWebsite   String?
  industry         String?
  companySize      String?
  companyLocation  String?
  taxNumber        String?
  subscriptionPlan String   @default("FREE")
  tokensAvailable  Int      @default(10)
  isVerified       Boolean  @default(false)
  
  // Relations
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobs             Job[]
  payments         Payment[]
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@map("employer_profiles")
}

model CandidateProfile {
  id               String   @id @default(cuid())
  userId           String   @unique
  fullName         String
  phoneNumber      String?
  avatar           String?
  location         String?
  title            String?
  bio              String?
  cvUrl            String?
  skills           String[]
  experienceLevel  String?  @default("ENTRY")
  education        Json?
  socialLinks      Json?
  
  // Relations
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  applications     Application[]
  interviews       Interview[]
  aiScores         AIScore[]
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@map("candidate_profiles")
}

model Job {
  id               String           @id @default(cuid())
  title            String
  description      String
  requirements     String[]
  responsibilities String[]
  location         String?
  remotePolicy     String?          @default("HYBRID")
  employmentType   String           @default("FULL_TIME")
  salaryRange      Json?
  experienceLevel  String           @default("MID_LEVEL")
  skillsRequired   String[]
  category         String
  tags             String[]
  
  // Status & Payment
  status           JobStatus        @default(UNPAID)
  isFeatured       Boolean          @default(false)
  isUrgent         Boolean          @default(false)
  
  // Pricing
  price            Float            @default(99.99)
  currency         String           @default("ETB")
  discountPercent  Int              @default(0)
  finalPrice       Float
  
  // Relations
  employerId       String
  employer         EmployerProfile  @relation(fields: [employerId], references: [id], onDelete: Cascade)
  applications     Application[]
  payments         Payment[]
  aiQuestions      AIQuestion[]
  
  // Timestamps
  expiresAt        DateTime?
  postedAt         DateTime?        @default(now())
  
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  
  @@index([employerId, status, category])
  @@map("jobs")
}

model Application {
  id               String             @id @default(cuid())
  jobId            String
  candidateId      String
  status           ApplicationStatus  @default(PENDING)
  appliedAt        DateTime           @default(now())
  
  // Cover Letter
  coverLetter      String?
  
  // AI Evaluation
  aiScore          Float?
  aiFeedback       String?
  aiTranscript     String?
  evaluatedAt      DateTime?
  
  // Relations
  job              Job                @relation(fields: [jobId], references: [id], onDelete: Cascade)
  candidate        CandidateProfile   @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  interviews       Interview[]
  
  // Timestamps
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  
  @@unique([jobId, candidateId])
  @@index([jobId, candidateId, status])
  @@map("applications")
}

model Interview {
  id               String           @id @default(cuid())
  applicationId    String
  interviewDate    DateTime
  duration         Int              @default(30) // minutes
  status           InterviewStatus  @default(SCHEDULED)
  
  // AI Integration
  videoUrl         String?
  transcript       String?
  aiAnalysis       Json?
  completionScore  Float?
  
  // Questions
  questions        Json             // Store AI-generated questions
  
  // Relations
  application      Application      @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  
  // Timestamps
  startedAt        DateTime?
  completedAt      DateTime?
  
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  
  @@index([applicationId, status])
  @@map("interviews")
}

model AIScore {
  id               String   @id @default(cuid())
  candidateId      String
  jobId            String
  applicationId    String
  technicalScore   Float
  behavioralScore  Float
  communicationScore Float
  overallScore     Float
  feedback         String
  strengths        String[]
  weaknesses       String[]
  
  // Relations
  candidate        CandidateProfile @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  job              Job              @relation(fields: [jobId], references: [id])
  application      Application      @relation(fields: [applicationId], references: [id])
  
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  
  @@unique([applicationId])
  @@index([candidateId, jobId])
  @@map("ai_scores")
}

model AIQuestion {
  id               String   @id @default(cuid())
  jobId            String
  questionText     String
  questionType     String   @default("TECHNICAL")
  difficulty       String   @default("MEDIUM")
  expectedKeywords String[]
  weight           Int      @default(20) // percentage
  
  job              Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@index([jobId])
  @@map("ai_questions")
}

model Payment {
  id               String        @id @default(cuid())
  employerId       String
  jobId            String
  amount           Float
  currency         String        @default("ETB")
  chapaReference   String        @unique
  status           PaymentStatus @default(PENDING)
  paymentMethod    String?
  
  // Webhook Data
  webhookData      Json?
  
  // Relations
  employer         EmployerProfile @relation(fields: [employerId], references: [id], onDelete: Cascade)
  job              Job             @relation(fields: [jobId], references: [id])
  
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  
  @@index([employerId, status, chapaReference])
  @@map("payments")
}

model Notification {
  id               String           @id @default(cuid())
  userId           String
  type             NotificationType
  title            String
  message          String
  data             Json?
  isRead           Boolean          @default(false)
  actionUrl        String?
  
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  
  @@index([userId, isRead, type])
  @@map("notifications")
}

model SystemLog {
  id               String   @id @default(cuid())
  level            String   @default("INFO")
  message          String
  userId           String?
  userRole         UserRole?
  action           String
  ipAddress        String?
  userAgent        String?
  metadata         Json?
  
  createdAt        DateTime @default(now())
  
  @@index([level, createdAt])
  @@map("system_logs")
}

model TokenUsage {
  id               String   @id @default(cuid())
  userId           String
  userRole         UserRole
  action           String
  tokensUsed       Int
  cost             Float
  model            String   @default("gpt-4")
  
  user             User     @relation(fields: [userId], references: [id])
  
  createdAt        DateTime @default(now())
  
  @@index([userId, createdAt])
  @@map("token_usage")
}